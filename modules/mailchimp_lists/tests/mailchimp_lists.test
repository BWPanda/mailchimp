<?php
/**
 * Tests the functionality of the Mailchimp Lists module.
 */

define('MC_TEST_EMAIL_1', 'test1@example.com');
define('MC_TEST_EMAIL_2', 'test2@example.com');
define('MC_TEST_EMAIL_3', 'test3@example.com');

class MailchimpListsBasicTestCase extends DrupalWebTestCase {
  protected $privileged_user;

  public static function getInfo() {
    // Note: getInfo() strings are not translated with t().
    return array(
      'name' => 'Mailchimp Lists',
      'description' => 'Test List Subscription Logic.',
      'group' => 'Mailchimp',
    );
  }

  /**
   * @return bool|void
   */
  public function setUp() {
    // Use a profile that contains required modules:
    $prof = drupal_get_profile();
    $this->profile = $prof;
    // Enable any modules required for the test. This should be an array of
    // module names.
    $enabled_modules = array(
      'libraries',
      'mailchimp',
      'entity',
      'entity_token',
      'mailchimp_lists',
    );
    parent::setUp($enabled_modules);
    variable_set('mailchimp_api_key', 'mailchimp_testing_mode');
    // Create and log in our privileged user.
    $this->staff_admin = $this->drupalCreateUser(array(
      'administer mailchimp',
    ));
    //$this->drupalLogin($this->staff_admin);

    // Create some lists:
    $lists = array();

    $list = new stdClass();
    $list->label = 'Anonymous Test List';
    $list->name = 'anonymous_test_list';
    $list->description = 'Anonymous list description';
    $list->list_type = 'freeform';
    $list->mc_list_id = 'test_list_A';
    $list->settings = array(
      'roles' => array(DRUPAL_AUTHENTICATED_RID => DRUPAL_AUTHENTICATED_RID, DRUPAL_ANONYMOUS_RID => DRUPAL_ANONYMOUS_RID),
      'mergefields' => array('EMAIL'),
      'cron' => FALSE,
      'doublein' => FALSE,
      'include_interest_groups' => FALSE,
    );
    $lists[] = $list;

    $list = new stdClass();
    $list->label = 'Optional Test List';
    $list->name = 'optional_test_list';
    $list->description = 'Optional list description';
    $list->list_type = 'optional';
    $list->mc_list_id = 'test_list_B';
    $list->settings = array(
      'roles' => array(DRUPAL_AUTHENTICATED_RID => DRUPAL_AUTHENTICATED_RID),
      'mergefields' => array(''),
      'cron' => FALSE,
      'doublein' => FALSE,
      'include_interest_groups' => FALSE,
    );
    $lists[] = $list;

    $list = new stdClass();
    $list->label = 'Required Test List';
    $list->name = 'required_test_list';
    $list->description = 'Required list description';
    $list->list_type = 'required';
    $list->mc_list_id = 'test_list_C';
    $list->settings = array(
      'roles' => array(DRUPAL_AUTHENTICATED_RID => DRUPAL_AUTHENTICATED_RID),
      'mergefields' => array(),
      'cron' => FALSE,
      'doublein' => FALSE,
      'include_interest_groups' => FALSE,
    );
    $lists[] = $list;

    foreach ($lists as $list) {
      mailchimp_lists_save($list);
    }
  }

  /**
   * Tests subscription to a mailchimp list from an anonymous user.
   */
  public function testMailchimpListSubscribeAnonymous() {
    $form_edit = array();
    $form_edit['mailchimp_lists[mailchimp_anonymous_test_list][mergevars][EMAIL]'] = MC_TEST_EMAIL_1;

    $this->drupalPost('mailchimp/subscribe', $form_edit, t('Subscribe'));
    $this->assertResponse(200, 'Anonymous subscription allowed.');

    $successful_subscription = mailchimp_is_subscribed('test_list_A', MC_TEST_EMAIL_1);

    $message = $successful_subscription ? "successful." : "failed.";
    $this->assertTrue($successful_subscription, 'Anonymous subscription ' . $message, 'Subscriptions');

    return TRUE;
  }

}
