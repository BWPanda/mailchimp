<?php
/**
 * Tests the functionality of the Mailchimp Lists module.
 */
class MailchimpListsBasicTestCase extends DrupalWebTestCase {
  protected $privileged_user;

  public static function getInfo() {
    // Note: getInfo() strings are not translated with t().
    return array(
      'name' => 'Mailchimp Lists',
      'description' => 'Test List Subscription Logic.',
      'group' => 'Mailchimp',
    );
  }

  /**
   * @return bool|void
   */
  public function setUp() {
    // Use a profile that contains required modules:
    $prof = drupal_get_profile();
    $this->profile = $prof;
    // Enable any modules required for the test. This should be an array of
    // module names.
    $enabled_modules = array(
      'libraries',
      'mailchimp',
      'entity',
      'entity_token',
      'mailchimp_lists',
    );
    parent::setUp($enabled_modules);
    variable_set('mailchimp_api_key', 'mailchimp_testing_mode');
    // Create and log in our privileged user.
    $this->staff_admin = $this->drupalCreateUser(array(
      'administer mailchimp',
    ));
    //$this->drupalLogin($this->staff_admin);

    // Create some lists:
    $lists = array();

    $list = new stdClass();
    $list->label = 'Anonymous Test List';
    $list->name = 'anonymous_test_list';
    $list->description = 'Anonymous list description';
    $list->list_type = 'freeform';
    $list->mc_list_id = 'test_list_A';
    $list->settings = array(
      'roles' => array(DRUPAL_AUTHENTICATED_RID => DRUPAL_AUTHENTICATED_RID, DRUPAL_ANONYMOUS_RID => DRUPAL_ANONYMOUS_RID),
      'mergefields' => array('EMAIL'),
      'cron' => FALSE,
      'doublein' => FALSE,
      'include_interest_groups' => FALSE,
    );
    $lists[] = $list;

    $list = new stdClass();
    $list->label = 'Optional Test List';
    $list->name = 'optional_test_list';
    $list->description = 'Optional list description';
    $list->list_type = 'optional';
    $list->mc_list_id = 'test_list_B';
    $list->settings = array(
      'roles' => array(DRUPAL_AUTHENTICATED_RID => DRUPAL_AUTHENTICATED_RID),
      'mergefields' => array(''),
      'cron' => FALSE,
      'doublein' => FALSE,
      'include_interest_groups' => FALSE,
    );
    $lists[] = $list;

    $list = new stdClass();
    $list->label = 'Required Test List';
    $list->name = 'required_test_list';
    $list->description = 'Required list description';
    $list->list_type = 'required';
    $list->mc_list_id = 'test_list_C';
    $list->settings = array(
      'roles' => array(DRUPAL_AUTHENTICATED_RID => DRUPAL_AUTHENTICATED_RID),
      'mergefields' => array(),
      'cron' => FALSE,
      'doublein' => FALSE,
      'include_interest_groups' => FALSE,
    );
    $lists[] = $list;

    foreach ($lists as $list) {
      mailchimp_lists_save($list);
    }
  }

  /**
   * Tests creation of a mailchimp list.
   */
  public function testMailchimpListCreate() {
    // Create node to edit.
    $edit = array();
    $edit['title'] = $edit['label'] = $this->randomName(8);
    $edit['list_type'] = 'required';
    $edit['mc_list_id'] = 'e6b08cb3fb';
    $edit["roles[2]"] = '2';
    // $edit["settings[mergefields][EMAIL]"] = "mail";
    $this->drupalPost('admin/config/services/mailchimp/lists/add', $edit, t('Save'));
    $this->assertText(t('Simpletest Example Node Type @title has been created.', array('@title' => $edit['title'])));
  }

}
